name: Deploy to Vercel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Ensure pg8000 is available for migration steps
        pip install pg8000

    - name: Run tests (fast subset)
      env:
        DATABASE_URL: sqlite:///./data.db
        FORCE_EPHEMERAL: '1'
        MAIL_SERVER: ''
        MAIL_USERNAME: ''
        MAIL_PASSWORD: ''
        PAYSTACK_PUBLIC: ''
        PAYSTACK_SECRET: ''
        SENDGRID_API_KEY: ''
      run: |
        source .venv/bin/activate
        python -m pytest -q -k "not e2e and not paystack and not email"

    - name: Ensure Vercel envs (set from GitHub secrets)
      if: ${{ secrets.VERCEL_TOKEN && secrets.VERCEL_PROJECT_ID }}
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || '' }}
        DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}
        PAYSTACK_SECRET_KEY: ${{ secrets.PAYSTACK_SECRET_KEY || '' }}
        PAYSTACK_PUBLIC_KEY: ${{ secrets.PAYSTACK_PUBLIC_KEY || '' }}
        MAIL_SERVER: ${{ secrets.MAIL_SERVER || '' }}
        MAIL_PORT: ${{ secrets.MAIL_PORT || '' }}
        MAIL_USERNAME: ${{ secrets.MAIL_USERNAME || '' }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD || '' }}
        MAIL_DEFAULT_SENDER: ${{ secrets.MAIL_DEFAULT_SENDER || '' }}
        ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL || '' }}
        SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY || '' }}
      run: |
        set -euo pipefail
        # install jq if not present
        if ! command -v jq >/dev/null 2>&1; then
          sudo apt-get update && sudo apt-get install -y jq
        fi

        PROJECT_ID="$VERCEL_PROJECT_ID"
        TOKEN="$VERCEL_TOKEN"

        # list of env vars to sync
        declare -A mapping
        mapping[PAYSTACK_SECRET_KEY]="$PAYSTACK_SECRET_KEY"
        mapping[PAYSTACK_PUBLIC_KEY]="$PAYSTACK_PUBLIC_KEY"
        mapping[MAIL_SERVER]="$MAIL_SERVER"
        mapping[MAIL_PORT]="$MAIL_PORT"
        mapping[MAIL_USERNAME]="$MAIL_USERNAME"
        mapping[MAIL_PASSWORD]="$MAIL_PASSWORD"
        mapping[MAIL_DEFAULT_SENDER]="$MAIL_DEFAULT_SENDER"
        mapping[ADMIN_EMAIL]="$ADMIN_EMAIL"
        mapping[SENDGRID_API_KEY]="$SENDGRID_API_KEY"
        mapping[ERROR_VIEW_TOKEN]="$ERROR_VIEW_TOKEN"
        # Prefer Neon secret when provided; otherwise, use DATABASE_URL
        DBURL="${NEON_DATABASE_URL:-${DATABASE_URL}}"
        mapping[DATABASE_URL]="$DBURL"

        for key in "${!mapping[@]}"; do
          value="${mapping[$key]}"
          if [ -z "$value" ]; then
            echo "Skipping $key (empty)"
            continue
          fi

          # Check for existing variable id
          id=$(curl -s -H "Authorization: Bearer $TOKEN" "https://api.vercel.com/v8/projects/$PROJECT_ID/env" | jq -r --arg key "$key" '.env | map(select(.key==$key)) | .[0].id // empty')
          if [ -n "$id" ]; then
            echo "Updating existing env var $key (id=$id)"
            curl -s -X DELETE -H "Authorization: Bearer $TOKEN" "https://api.vercel.com/v8/projects/$PROJECT_ID/env/$id"
          else
            echo "Adding new env var $key"
          fi

          # Create env var
          curl -s -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
               -d "{\"key\":\"$key\",\"value\":\"$value\",\"target\":[\"production\"]}" \
               "https://api.vercel.com/v8/projects/$PROJECT_ID/env"
        done

    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    - name: Run DB migrations (optional)
      if: ${{ secrets.NEON_DATABASE_URL || secrets.DATABASE_URL }}
      env:
        NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || '' }}
        NEON_DATABASE_URL_UNPOOLED: ${{ secrets.NEON_DATABASE_URL_UNPOOLED || '' }}
        DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}
        FLASK_APP: app.py
      run: |
        set -euo pipefail
        echo "Running alembic/Flask-Migrate upgrade..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pg8000
        # Prefer Neon secret when present
        # Prefer the unpooled neon URL for migrations if available, otherwise prefer the pooled neon URL, then DATABASE_URL
        DBURL="${NEON_DATABASE_URL_UNPOOLED:-${NEON_DATABASE_URL:-${DATABASE_URL}}}"
        # Rewrite scheme to pg8000 dialect if necessary
        DBURL=$(echo "$DBURL" | sed -e 's|^postgres://|postgresql+pg8000://|' -e 's|^postgresql://|postgresql+pg8000://|')
        export SQLALCHEMY_DATABASE_URI="$DBURL"
        python -m flask db upgrade
          - name: Upload last_error artifact if present
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: last_error_deploy_migration
              path: /tmp/last_error.txt
              if-no-files-found: ignore
