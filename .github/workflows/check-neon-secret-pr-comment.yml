name: Check Neon Secret on PR

on:
  pull_request:
    branches: [ main, fix/* ]

jobs:
  neon-secret-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check if NEON_DATABASE_URL is set
      id: check_secret
      run: |
        # This just prints whether the secret is present. The github-script below will react to it.
        if [ -z "${{ secrets.NEON_DATABASE_URL }}" ]; then
          echo "neon_secret_present=false" >> $GITHUB_OUTPUT
        else
          echo "neon_secret_present=true" >> $GITHUB_OUTPUT
        fi

    - name: Comment on PR if Neon secret is missing
      if: ${{ steps.check_secret.outputs.neon_secret_present == 'false' }}
      uses: actions/github-script@v6
      with:
        script: |
          const pr_number = context.payload.pull_request.number;
          const owner = context.repo.owner; const repo = context.repo.repo;
          const matchText = '⚠️ **Neon DB secret missing**';
          const body = '⚠️ **Neon DB secret missing**\n\n' +
                   'The repository secret **NEON_DATABASE_URL** is not set. The Neon CI workflow requires this secret to run Neon integration tests.\n\n' +
                   'If you want Neon-based CI to run for this PR, please add the secret in the repository settings: Settings → Secrets & variables → Actions → New repository secret. Use a Neon pooled URL (e.g., ```postgresql://neondb_owner:password@.../neondb?sslmode=require```).\n\n' +
                   'Once the secret is set, re-run the workflows for coverage (Actions -> <workflow> -> Re-run).';

          // Dedupe: check existing comments for a matching bot comment
          const comments = await github.rest.issues.listComments({ owner, repo, issue_number: pr_number });
          const existing = comments.data.find(c => c.body && c.body.includes(matchText));
          if (existing) {
            console.log('Existing Neon-secret-missing comment found (id=' + existing.id + '), skipping.');
            return;
          }
          await github.rest.issues.createComment({ owner, repo, issue_number: pr_number, body });

    - name: Add successful check comment if present (optional)
      if: ${{ steps.check_secret.outputs.neon_secret_present == 'true' }}
      uses: actions/github-script@v6
      with:
        script: |
          const pr_number = context.payload.pull_request.number;
          const owner = context.repo.owner; const repo = context.repo.repo;
          const matchText = '✅ The **NEON_DATABASE_URL** secret is present.';
          const body = '✅ The **NEON_DATABASE_URL** secret is present. Neon integration tests will run where configured.\n\n' +
                       'If you want Neon CI to run against a specific test DB, ensure the secret points to that DB and not your production DB.';
          // Dedupe: don't post the success message if already posted
          const comments = await github.rest.issues.listComments({ owner, repo, issue_number: pr_number });
          const existing = comments.data.find(c => c.body && c.body.includes(matchText));
          if (existing) {
            console.log('Existing neon-secret-present comment found (id=' + existing.id + '), skipping.');
            return;
          }
          await github.rest.issues.createComment({ owner, repo, issue_number: pr_number, body });
