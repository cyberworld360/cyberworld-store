{% extends 'base.html' %}
{% block content %}
<style>
  /* Homepage background styling */
  body {
    background-image: url('{{ settings.get_bg_url() }}');
    background-attachment: fixed;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  
  .products .card {
    background: rgba(255, 255, 255, 0.92);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
  }
  .featured .card {
    background: rgba(255, 255, 255, 0.92);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
  }
</style>

<style>
  /* Card size variants */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }
  
  .card.card-small {
    grid-column: span 1;
    min-height: 280px;
  }
  
  .card.card-small img {
    height: 120px;
    object-fit: cover;
  }
  
  .card.card-medium {
    grid-column: span 1;
    min-height: 350px;
  }
  
  .card.card-medium img {
    height: 180px;
    object-fit: cover;
  }
  
  .card.card-large {
    grid-column: span 2;
    min-height: 400px;
  }
  
  .card.card-large img {
    height: 250px;
    object-fit: cover;
  }
  
  @media (max-width: 768px) {
    .card.card-large {
      grid-column: span 1;
    }
  }
</style>

<section class="ads-slider">
  <div class="slide active"><img src="{{ settings.get_banner1_url() }}" alt="Ad 1" /></div>
  <div class="slide"><img src="{{ settings.get_banner2_url() }}" alt="Ad 2" /></div>
</section>

<section class="hero">
  <h2>Shop best sellers</h2>
  <p>Discover top-rated products and great deals</p>
</section>

<section class="featured">
  <h3>Featured Products</h3>
  <div class="featured-controls">
    <button class="featured-prev">‚óÄ</button>
    <button class="featured-next">‚ñ∂</button>
  </div>
  <div class="featured-track">
    {% for p in featured %}
    <div class="card card-featured transition-all" role="listitem">
      <div style="position: relative; overflow: hidden; border-radius: 8px 8px 0 0;">
        <img loading="lazy" src="{{ p.image or settings.get_bg_url() }}" alt="{{ p.title }}" onerror="this.src='{{ settings.get_bg_url() }}'" decoding="async" class="img-responsive" />
        {% if p.is_latest %}
        <span class="badge-latest" aria-label="New product">üÜï NEW</span>
        {% endif %}
        <span class="badge-featured" aria-label="Featured">‚≠ê Featured</span>
      </div>
      <h4 class="line-clamp-2">{{ p.title }}</h4>
      <p class="price" aria-label="Price">{{ p.price_ghc|money }} {% if p.old_price_ghc %}<span class="old line-through">{{ p.old_price_ghc|money }}</span>{% endif %}</p>
      <a href="/product/{{ p.id }}" class="btn btn-primary" style="width: 100%; text-align: center; margin-top: auto;">View Details</a>
    </div>
    {% endfor %}
  </div>
</section>

<section id="products" class="products">
  <h2 style="margin: 2rem 0 1rem 0;">üì¶ All Products</h2>
  <div class="grid">
    {% for p in products %}
    <div class="card card-{{ p.card_size or 'medium' }} transition-all hover-lift" role="listitem">
      <div style="position: relative; overflow: hidden; border-radius: 8px 8px 0 0;">
        <img 
          loading="lazy" 
          src="{{ p.image or settings.get_bg_url() }}" 
          alt="{{ p.title }}" 
          onerror="this.src='{{ settings.get_bg_url() }}'" 
          decoding="async"
          class="img-responsive"
        />
        {% if p.is_latest %}
        <span class="badge-latest" aria-label="New product">üÜï NEW</span>
        {% endif %}
        {% if p.featured %}
        <span class="badge-featured" style="top: 50px;" aria-label="Featured">‚≠ê FEATURED</span>
        {% endif %}
      </div>
      <h4 class="line-clamp-2">{{ p.title }}</h4>
      <p class="text-muted line-clamp-2">{{ p.short }}</p>
      <p class="price" aria-label="Price">{{ p.price_ghc|money }} {% if p.old_price_ghc %}<span class="old line-through">{{ p.old_price_ghc|money }}</span>{% endif %}</p>
      <form action="/cart/add/{{ p.id }}" method="post" aria-label="Add {{ p.title }} to cart" class="product-form">
        <label for="qty-{{ p.id }}" class="sr-only">Quantity for {{ p.title }}</label>
        <input id="qty-{{ p.id }}" type="number" name="qty" value="1" min="1" max="999" title="Quantity" placeholder="Qty" aria-label="Quantity" />
        <button class="btn btn-primary btn-add-cart" type="submit" aria-label="Add {{ p.title }} to cart">üõí Add</button>
      </form>
      <a href="/product/{{ p.id }}" class="btn btn-outline">View Details</a>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Auto-slider scripts for featured products and ads -->
<script>
;(function(){
  // Featured products horizontal track auto-scroll
  const track = document.querySelector('.featured-track');
  const prevBtn = document.querySelector('.featured-prev');
  const nextBtn = document.querySelector('.featured-next');
  if (track) {
    let timer = null;
    const interval = 4000; // ms
    const pageAmount = 0.9; // fraction of visible width to scroll

    function step() {
      const maxScroll = track.scrollWidth - track.clientWidth;
      const next = Math.min(track.scrollLeft + Math.round(track.clientWidth * pageAmount), maxScroll);
      track.scrollTo({ left: next, behavior: 'smooth' });
      if (next >= maxScroll - 5) {
        // loop back to start after a short delay
        setTimeout(() => track.scrollTo({ left: 0, behavior: 'smooth' }), interval / 2);
      }
    }

    function start() { if (!timer) timer = setInterval(step, interval); }
    function stop() { if (timer) { clearInterval(timer); timer = null; } }

    track.addEventListener('mouseenter', stop);
    track.addEventListener('mouseleave', start);

    if (prevBtn) prevBtn.addEventListener('click', (e) => { e.preventDefault(); stop(); track.scrollBy({ left: -Math.round(track.clientWidth * pageAmount), behavior: 'smooth' }); setTimeout(start, interval); });
    if (nextBtn) nextBtn.addEventListener('click', (e) => { e.preventDefault(); stop(); track.scrollBy({ left: Math.round(track.clientWidth * pageAmount), behavior: 'smooth' }); setTimeout(start, interval); });

    // start auto-scroll (only if overflow exists)
    if (track.scrollWidth > track.clientWidth) start();
  }

  // Ads slider auto-rotate (fades slides by toggling .active)
  const slides = document.querySelectorAll('.ads-slider .slide');
  if (slides && slides.length > 1) {
    let idx = 0;
    const adInterval = 5000;
    setInterval(() => {
      slides[idx].classList.remove('active');
      idx = (idx + 1) % slides.length;
      slides[idx].classList.add('active');
    }, adInterval);
  }
})();
</script>

{% endblock %}