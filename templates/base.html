<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CyberWorldStore</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
      :root {
        --primary-color: {{ settings.primary_color }};
        --secondary-color: {{ settings.secondary_color }};
        --primary-font: {{ settings.primary_font }};
        --secondary-font: {{ settings.secondary_font }};
        --logo-height: {{ settings.logo_height }}px;
        --logo-top: {{ settings.logo_top_px }}px;
        --header-top: {{ settings.logo_top_px or 8 }}px;
        --logo-zindex: {{ settings.logo_zindex }};
      }
      body {
        font-family: var(--primary-font);
        margin: 0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      }
      h1, h2, h3, h4, h5, h6 {
        font-family: var(--secondary-font);
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="header-top-bar">
        <!-- Mobile Toggle (visible only on small screens) -->
        <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="main-nav-panel">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>

        <!-- Logo - Center on desktop, left-adjust on mobile -->
        <div class="brand-wrapper">
          <a href="/" class="brand" aria-label="Home - Cyber World Store">
            <img class="logo-img" src="{{ settings.get_logo_url() }}" alt="{{ settings.site_name or 'Cyber World Store' }}" />
          </a>
        </div>

        <!-- Cart Icon (always visible) -->
        <a href="/cart" class="cart-link" aria-label="View shopping cart">
          <span class="cart-icon">ğŸ›’</span>
          <span class="cart-count" aria-live="polite" aria-atomic="true"></span>
        </a>
      </div>

      <!-- Navigation Panel (hidden on desktop, visible when toggled on mobile) -->
      <nav id="main-nav-panel" class="main-nav-panel" aria-label="Main navigation">
        <div class="nav-content">
          <div class="nav-section nav-user-section">
            {% if current_user.is_authenticated %}
              {% if current_user.username is defined %}
                <!-- Admin User Section -->
                <div class="nav-user-info admin-user">
                  <span class="nav-badge">Admin</span>
                  <span class="nav-user-label">Administrator</span>
                </div>
              {% else %}
                <!-- Customer User Section -->
                <div class="nav-user-info customer-user">
                  <span class="nav-user-email">{{ current_user.email }}</span>
                </div>
              {% endif %}
            {% else %}
              <div class="nav-user-info guest-user">
                <span class="nav-user-label">Welcome Guest</span>
              </div>
            {% endif %}
          </div>

          <!-- Main Navigation Links -->
          <div class="nav-section nav-links-section">
            {% if current_user.is_authenticated %}
              {% if current_user.username is defined %}
                <!-- Admin Navigation -->
                <a href="/admin" class="nav-link">
                  <span class="nav-icon">ğŸ“Š</span> Dashboard
                </a>
                <a href="/admin/orders" class="nav-link">
                  <span class="nav-icon">ğŸ“¦</span> Orders
                </a>
                <a href="/admin/wallets" class="nav-link">
                  <span class="nav-icon">ğŸ’³</span> Wallets
                </a>
                <a href="/admin/coupons" class="nav-link">
                  <span class="nav-icon">ğŸŸï¸</span> Coupons
                </a>
                <a href="/admin/sliders" class="nav-link">
                  <span class="nav-icon">ğŸ </span> Sliders
                </a>
                <a href="/admin/settings" class="nav-link">
                  <span class="nav-icon">âš™ï¸</span> Settings
                </a>
              {% else %}
                <!-- Customer Navigation -->
                <a href="/" class="nav-link">
                  <span class="nav-icon">ğŸ </span> Home
                </a>
                <a href="/account" class="nav-link">
                  <span class="nav-icon">ğŸ‘¤</span> My Account
                </a>
                <a href="/cart" class="nav-link">
                  <span class="nav-icon">ğŸ›’</span> Cart
                </a>
              {% endif %}
            {% else %}
              <!-- Guest Navigation -->
              <a href="/" class="nav-link">
                <span class="nav-icon">ğŸ </span> Home
              </a>
              <a href="/admin/login" class="nav-link">
                <span class="nav-icon">ğŸ‘¨â€ğŸ’¼</span> Admin
              </a>
              <a href="/register" class="nav-link">
                <span class="nav-icon">ğŸ“</span> Register
              </a>
              <a href="/login" class="nav-link">
                <span class="nav-icon">ğŸ”‘</span> Login
              </a>
            {% endif %}
          </div>

          <!-- Action Links (Desktop Menu) -->
          <div class="nav-section nav-actions-section desktop-only">
            {% if current_user.is_authenticated %}
              <a href="/account" class="nav-link-accent">My Account</a>
              <a href="/logout" class="nav-link nav-logout">Logout</a>
            {% else %}
              <a href="/login" class="nav-link-accent">Login</a>
            {% endif %}
          </div>

          <!-- Mobile Action Links -->
          <div class="nav-section nav-actions-section mobile-only">
            {% if current_user.is_authenticated %}
              <a href="/logout" class="nav-link nav-logout">
                <span class="nav-icon">ğŸšª</span> Logout
              </a>
            {% else %}
              <a href="/login" class="nav-link-accent">
                <span class="nav-icon">ğŸ”‘</span> Login
              </a>
            {% endif %}
          </div>
        </div>
      </nav>

      <!-- Desktop Navigation Bar (hidden on mobile) -->
      <div class="desktop-nav-bar">
        <div class="nav-desktop-links">
          {% if current_user.is_authenticated %}
            {% if current_user.username is defined %}
              <!-- Admin Quick Links -->
              <a href="/admin" class="nav-desktop-link">Dashboard</a>
              <a href="/admin/orders" class="nav-desktop-link">Orders</a>
              <a href="/admin/wallets" class="nav-desktop-link">Wallets</a>
              <a href="/admin/settings" class="nav-desktop-link">Settings</a>
              <a href="/admin/logout" class="nav-desktop-link nav-logout">Logout</a>
            {% else %}
              <!-- Customer Quick Links -->
              <a href="/account" class="nav-desktop-link">My Account</a>
              <a href="/logout" class="nav-desktop-link nav-logout">Logout</a>
            {% endif %}
          {% else %}
            <a href="/admin/login" class="nav-desktop-link">Admin</a>
            <a href="/register" class="nav-desktop-link">Register</a>
            <a href="/login" class="nav-desktop-link nav-login-btn">Login</a>
          {% endif %}
        </div>
      </div>
    </header>
    <main class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-list" role="status" aria-live="polite">
            {% for category, msg in messages %}
              <div class="flash {{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
                {% if settings.custom_css and settings.custom_css|trim %}
                <style>
    {{ settings.custom_css|safe }}
                </style>
                {% endif %}
    <footer class="site-footer">
      <div class="container">Â© {{ now.year }} Cyber World Store</div>
    </footer>
    
    <script>
      // Mobile Navigation Toggle
      document.addEventListener('DOMContentLoaded', function(){
        const mobileToggle = document.getElementById('mobile-menu-toggle');
        const navPanel = document.getElementById('main-nav-panel');
        
        if (mobileToggle && navPanel) {
          // Toggle nav panel on button click
          mobileToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = navPanel.classList.toggle('open');
            mobileToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          });
          
          // Close nav when clicking a link inside it
          navPanel.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
              navPanel.classList.remove('open');
              mobileToggle.setAttribute('aria-expanded', 'false');
            });
          });
          
          // Close nav when clicking outside of it
          document.addEventListener('click', (e) => {
            if (!navPanel.contains(e.target) && !mobileToggle.contains(e.target)) {
              navPanel.classList.remove('open');
              mobileToggle.setAttribute('aria-expanded', 'false');
            }
          });
          
          // Close nav on Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && navPanel.classList.contains('open')) {
              navPanel.classList.remove('open');
              mobileToggle.setAttribute('aria-expanded', 'false');
            }
          });
        }
      });

      // Simple autoslider for ads (rotates images)
      document.addEventListener('DOMContentLoaded', function(){
        // Ads slider
        const ads = document.querySelectorAll('.ads-slider .slide');
        let adIndex = 0;
        if (ads.length > 0) {
          setInterval(() => {
            ads[adIndex].classList.remove('active');
            adIndex = (adIndex + 1) % ads.length;
            ads[adIndex].classList.add('active');
          }, 4000);
        }

        // Featured product slider controls
        const prevBtn = document.querySelector('.featured-prev');
        const nextBtn = document.querySelector('.featured-next');
        const track = document.querySelector('.featured-track');
        if (prevBtn && nextBtn && track) {
          const cardWidth = track.querySelector('.card').offsetWidth + 16;
          prevBtn.addEventListener('click', () => { track.scrollBy({ left: -cardWidth, behavior: 'smooth' }); });
          nextBtn.addEventListener('click', () => { track.scrollBy({ left: cardWidth, behavior: 'smooth' }); });
        }
      });

        // Cart count population: fetch /cart and parse quantities from the cart table
        document.addEventListener('DOMContentLoaded', function(){
          const cartCountEl = document.querySelector('.cart-count');
          function setCartCount(n){
            if (!cartCountEl) return;
            if (!n || Number(n) === 0) {
              cartCountEl.textContent = '';
              cartCountEl.style.display = 'none';
              return;
            }
            cartCountEl.textContent = String(n);
            cartCountEl.style.display = 'inline-block';
          }

          async function fetchCartCount(){
              try {
                // Prefer the compact JSON endpoint, fallback to scraping /cart
                const resJson = await fetch('/api/cart-count', { credentials: 'same-origin' });
                if (resJson && resJson.ok) {
                  const data = await resJson.json();
                  if (data && typeof data.count !== 'undefined') {
                    return setCartCount(Number(data.count) || 0);
                  }
                }
                const res = await fetch('/cart', { credentials: 'same-origin' });
                if (!res.ok) return setCartCount(0);
                const text = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
              // Try to find the cart table and qty inputs
              let count = 0;
              const qtyInputs = doc.querySelectorAll('input[name^="qty_"]');
              if (qtyInputs && qtyInputs.length) {
                qtyInputs.forEach(i => { try { count += Number(i.value || 0); } catch(e){} });
              } else {
                // Try to detect rows in cart-table
                const rows = doc.querySelectorAll('.cart-table tbody tr');
                if (rows && rows.length) {
                  rows.forEach(r => {
                    const input = r.querySelector('input[type="number"]');
                    if (input) { try { count += Number(input.value || 0); } catch(e){} }
                  });
                  // if still zero, fallback to number of rows
                  if (count === 0) count = rows.length;
                } else {
                  // If cart page shows "Your cart is empty." then 0
                  if (text.includes('Your cart is empty')) count = 0;
                }
              }
              setCartCount(count || 0);
            } catch (err) {
              // on error don't fail silently; hide count
              setCartCount(0);
            }
          }

          // Update count on load and periodically (in case of client-side changes)
          fetchCartCount();
          // Also listen for clicks on add-to-cart buttons to provide instant feedback (best-effort)
          document.body.addEventListener('submit', function(e){
            const form = e.target;
            if (!form || !(form instanceof HTMLFormElement)) return;
            if (form.action && form.action.includes('/cart/add')) {
              // Try to update local room: read qty and update displayed value
              const formQty = form.querySelector('input[name="qty"], input[type="number"]');
              let qty = 1;
              if (formQty && formQty.value) {
                qty = Number(formQty.value) || 1;
              }
              // Attempt to read the current count displayed and increment it
              const cur = Number(cartCountEl ? (cartCountEl.textContent || '0') : '0') || 0;
              setCartCount(cur + qty);
            }
          }, true);

          // Poll occasionally (every 30s) to keep the header count accurate for long-lived pages
          setInterval(fetchCartCount, 30000);
        });
    </script>
    
    <!-- Real-time Settings Synchronization Script -->
    <!-- This enables instant admin settings changes across all user browsers -->
    <script src="/static/js/settings-sync.js"></script>
  </body>
</html>