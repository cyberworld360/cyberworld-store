<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CyberWorld Store</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
      :root {
        --primary-color: {{ settings.primary_color }};
        --secondary-color: {{ settings.secondary_color }};
        --primary-font: {{ settings.primary_font }};
        --secondary-font: {{ settings.secondary_font }};
        --logo-height: {{ settings.logo_height }}px;
        --logo-top: {{ settings.logo_top_px }}px;
        --header-top: {{ settings.logo_top_px or 8 }}px;
        --logo-zindex: {{ settings.logo_zindex }};
      }
      body {
        font-family: var(--primary-font);
        margin: 0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      }
      h1, h2, h3, h4, h5, h6 {
        font-family: var(--secondary-font);
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-grid">
        {% if settings.cart_on_right %}
        <div class="header-left">
          <button id="mobile-menu-toggle-left" class="mobile-menu-toggle mobile-menu-toggle-left" aria-label="Toggle menu" aria-expanded="false">â˜°</button>
          <nav class="main-nav">
            <div class="nav-panel" aria-hidden="true">
            <a href="/cart" class="cart-link">ðŸ›’ Cart</a>
            <a href="/cart" class="cart-link" aria-label="Cart">ðŸ›’<span class="cart-count" aria-live="polite" aria-atomic="true"></span></a>
            {% if current_user.is_authenticated %}
              {% if current_user.username is defined %}
                <!-- Admin links - grouped under hamburger menu -->
                <a href="/admin">Admin</a>
                <a href="/admin/wallets">Wallets</a>
                <a href="/admin/sliders">Sliders</a>
                <a href="/admin/coupons">Coupons</a>
                <a href="/admin/settings">Settings</a>
                <a href="/admin/logout">Admin Logout</a>
              {% else %}
                <!-- Customer links hidden in panel for access via menu -->
                <span class="panel-user">{{ current_user.email }}</span>
                <a href="/account">My Account</a>
                <a href="/logout">Logout</a>
              {% endif %}
            {% else %}
              <a href="/cart" class="cart-link">ðŸ›’ Cart</a>
              <a href="/admin/login">Admin</a>
              <a href="/register">Register</a>
              <a href="/login">Customer Login</a>
            {% endif %}
          </div>
            </div>
          </nav>
        </div>
        {% else %}
        <div class="header-left">
          <a href="/cart" class="cart-link" aria-label="Cart">ðŸ›’<span class="cart-count" aria-live="polite" aria-atomic="true"></span></a>
        </div>
        {% endif %}
        <div class="brand center-logo" style="top: calc({{ settings.logo_top_px or 8 }}px); z-index: {{ settings.logo_zindex or 9999 }};">
          <a href="/" aria-label="Home">
            <img class="logo-img" src="{{ settings.get_logo_url() }}" alt="{{ settings.site_name or 'CyberWorld Store' }}" />
          </a>
        </div>
        {% if settings.cart_on_right %}
        <div class="header-right">
          <a href="/cart" class="cart-link" aria-label="Cart">ðŸ›’<span class="cart-count" aria-live="polite" aria-atomic="true"></span></a>
        </div>
        {% else %}
        <div class="header-right">
          <button id="mobile-menu-toggle-right" class="mobile-menu-toggle mobile-menu-toggle-right" aria-label="Toggle menu" aria-expanded="false">â˜°</button>
          <nav class="main-nav">
            <div class="nav-panel" aria-hidden="true">
            {% if current_user.is_authenticated %}
              {% if current_user.username is defined %}
                <!-- Admin links - grouped under hamburger menu -->
                <a href="/admin">Admin</a>
                <a href="/admin/wallets">Wallets</a>
                <a href="/admin/sliders">Sliders</a>
                <a href="/admin/coupons">Coupons</a>
                <a href="/admin/settings">Settings</a>
                <a href="/admin/logout">Admin Logout</a>
              {% else %}
                <!-- Customer links hidden in panel for access via menu -->
                <span class="panel-user">{{ current_user.email }}</span>
                <a href="/account">My Account</a>
                <a href="/logout">Logout</a>
              {% endif %}
            {% else %}
              <a href="/admin/login">Admin</a>
              <a href="/register">Register</a>
              <a href="/login">Customer Login</a>
            {% endif %}
          </div>
            </div>
          </nav>
          <div class="header-inline-links">
            {% if not settings.cart_on_right %}
              <a href="/cart" class="cart-link" aria-label="Cart">ðŸ›’<span class="cart-count" aria-live="polite" aria-atomic="true"></span></a>
            {% endif %}
            {% if current_user.is_authenticated %}
              <a href="/account">My Account</a>
              <a href="/logout">Logout</a>
            {% else %}
              <a href="/register">Register</a>
              <a href="/login">Login</a>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </header>
    <main class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-list" role="status" aria-live="polite">
            {% for category, msg in messages %}
              <div class="flash {{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
    {% if settings.custom_css %}
    <style>
    {{ settings.custom_css|safe }}
    </style>
    {% endif %}
    <footer class="site-footer">
      <div class="container">Â© {{ now.year }} CyberWorld</div>
    </footer>
    
    <script>
      // Mobile nav toggle
      document.addEventListener('DOMContentLoaded', function(){
        // Toggle all mobile menu buttons; each toggles the nearest .main-nav
        const toggles = document.querySelectorAll('.mobile-menu-toggle');
        toggles.forEach(toggle => {
          const nav = toggle.closest('.header-left, .header-right')?.querySelector('.main-nav') || document.querySelector('.main-nav');
          if (!nav) return;
          const panel = nav.querySelector('.nav-panel');
          toggle.addEventListener('click', () => {
            nav.classList.toggle('open');
            const isOpen = nav.classList.contains('open');
            // actually update aria-hidden on panel and aria-expanded on the toggle
            if (panel) panel.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
            toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          });
        });
        // Close open nav when clicking outside
        document.addEventListener('click', (e) => {
          const openNavs = document.querySelectorAll('.main-nav.open');
          openNavs.forEach(nav => {
            if (nav.contains(e.target) || e.target.closest('.mobile-menu-toggle')) return;
            nav.classList.remove('open');
            const panel = nav.querySelector('.nav-panel');
            if (panel) panel.setAttribute('aria-hidden', 'true');
            const toggles = document.querySelectorAll('.mobile-menu-toggle');
            toggles.forEach(t => t.setAttribute('aria-expanded', 'false'));
          });
        });
      });

      // Simple autoslider for ads (rotates images)
      document.addEventListener('DOMContentLoaded', function(){
        // Ads slider
        const ads = document.querySelectorAll('.ads-slider .slide');
        let adIndex = 0;
        if (ads.length > 0) {
          setInterval(() => {
            ads[adIndex].classList.remove('active');
            adIndex = (adIndex + 1) % ads.length;
            ads[adIndex].classList.add('active');
          }, 4000);
        }

        // Featured product slider controls
        const prevBtn = document.querySelector('.featured-prev');
        const nextBtn = document.querySelector('.featured-next');
        const track = document.querySelector('.featured-track');
        if (prevBtn && nextBtn && track) {
          const cardWidth = track.querySelector('.card').offsetWidth + 16;
          prevBtn.addEventListener('click', () => { track.scrollBy({ left: -cardWidth, behavior: 'smooth' }); });
          nextBtn.addEventListener('click', () => { track.scrollBy({ left: cardWidth, behavior: 'smooth' }); });
        }
      });

        // Cart count population: fetch /cart and parse quantities from the cart table
        document.addEventListener('DOMContentLoaded', function(){
          const cartCountEl = document.querySelector('.cart-count');
          function setCartCount(n){
            if (!cartCountEl) return;
            if (!n || Number(n) === 0) {
              cartCountEl.textContent = '';
              cartCountEl.style.display = 'none';
              return;
            }
            cartCountEl.textContent = String(n);
            cartCountEl.style.display = 'inline-block';
          }

          async function fetchCartCount(){
              try {
                // Prefer the compact JSON endpoint, fallback to scraping /cart
                const resJson = await fetch('/api/cart-count', { credentials: 'same-origin' });
                if (resJson && resJson.ok) {
                  const data = await resJson.json();
                  if (data && typeof data.count !== 'undefined') {
                    return setCartCount(Number(data.count) || 0);
                  }
                }
                const res = await fetch('/cart', { credentials: 'same-origin' });
                if (!res.ok) return setCartCount(0);
                const text = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
              // Try to find the cart table and qty inputs
              let count = 0;
              const qtyInputs = doc.querySelectorAll('input[name^="qty_"]');
              if (qtyInputs && qtyInputs.length) {
                qtyInputs.forEach(i => { try { count += Number(i.value || 0); } catch(e){} });
              } else {
                // Try to detect rows in cart-table
                const rows = doc.querySelectorAll('.cart-table tbody tr');
                if (rows && rows.length) {
                  rows.forEach(r => {
                    const input = r.querySelector('input[type="number"]');
                    if (input) { try { count += Number(input.value || 0); } catch(e){} }
                  });
                  // if still zero, fallback to number of rows
                  if (count === 0) count = rows.length;
                } else {
                  // If cart page shows "Your cart is empty." then 0
                  if (text.includes('Your cart is empty')) count = 0;
                }
              }
              setCartCount(count || 0);
            } catch (err) {
              // on error don't fail silently; hide count
              setCartCount(0);
            }
          }

          // Update count on load and periodically (in case of client-side changes)
          fetchCartCount();
          // Also listen for clicks on add-to-cart buttons to provide instant feedback (best-effort)
          document.body.addEventListener('submit', function(e){
            const form = e.target;
            if (!form || !(form instanceof HTMLFormElement)) return;
            if (form.action && form.action.includes('/cart/add')) {
              // Try to update local room: read qty and update displayed value
              const formQty = form.querySelector('input[name="qty"], input[type="number"]');
              let qty = 1;
              if (formQty && formQty.value) {
                qty = Number(formQty.value) || 1;
              }
              // Attempt to read the current count displayed and increment it
              const cur = Number(cartCountEl ? (cartCountEl.textContent || '0') : '0') || 0;
              setCartCount(cur + qty);
            }
          }, true);

          // Poll occasionally (every 30s) to keep the header count accurate for long-lived pages
          setInterval(fetchCartCount, 30000);
        });
    </script>
  </body>
</html>