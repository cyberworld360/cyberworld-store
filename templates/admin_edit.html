{% extends 'base.html' %}
{% block content %}
<div class="admin-form-container">
  <h2>{% if product %}Edit Product{% else %}Add New Product (unlimited){% endif %}</h2>
  <p class="admin-unlimited-note">Admins may add unlimited products for customers to shop — no product count limits enforced.</p>
  
  <form method="post" enctype="multipart/form-data" class="admin-form">
    <div class="form-group">
      <label for="title">Product Title *</label>
      <input 
        type="text" 
        id="title"
        name="title" 
        value="{{ product.title if product else '' }}" 
        required 
        placeholder="Enter product name"
        maxlength="255"
      />
      <small>Required field. Max 255 characters.</small>
    </div>

    <div class="form-group">
      <label for="short">Product Description</label>
      <textarea 
        id="short"
        name="short"
        placeholder="Enter product description"
        rows="4"
        maxlength="500"
      >{{ product.short if product else '' }}</textarea>
      <small>Optional. Max 500 characters.</small>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="price">Price (GH₵) *</label>
        <input 
          type="number" 
          id="price"
          name="price" 
          value="{{ product.price_ghc if product else '' }}" 
          required 
          step="0.01"
          min="0"
          placeholder="0.00"
        />
        <small>Required field. Selling price.</small>
      </div>

      <div class="form-group">
        <label for="old_price">Old Price (GH₵)</label>
        <input 
          type="number" 
          id="old_price"
          name="old_price" 
          value="{{ product.old_price_ghc if product else '' }}" 
          step="0.01"
          min="0"
          placeholder="0.00"
        />
        <small>Optional. Used to show discount.</small>
      </div>
    </div>

    <div class="form-group">
      <label for="image_file">Upload Product Image</label>
      <input 
        type="file" 
        id="image_file"
        name="image_file" 
        accept=".png,.jpg,.jpeg,.gif"
      />
      <small>Allowed formats: PNG, JPG, JPEG, GIF. Max 5MB.</small>
      
      <!-- Current image (if editing) -->
      {% if product and product.image %}
        <div class="current-image">
          <p>Current image:</p>
          <img src="{{ product.image }}" alt="{{ product.title }}" class="current-image-img" id="current-img">
        </div>
      {% endif %}
      
      <!-- Image preview before upload -->
      <div id="preview-container" style="display:none; margin-top:15px;">
        <p style="margin:0 0 10px 0; color:#666; font-weight:bold;">Preview of new image:</p>
        <div style="position:relative; display:inline-block;">
          <img id="preview-image" src="" alt="Preview" style="max-width:200px; max-height:200px; border:2px solid #007bff; border-radius:4px; display:block;">
          <div id="image-info" style="margin-top:8px; font-size:12px; color:#555;">
            <p id="image-size" style="margin:4px 0;"></p>
            <p id="image-dimensions" style="margin:4px 0;"></p>
          </div>
          <button type="button" id="cancel-preview-btn" class="btn btn-secondary" style="margin-top:10px; padding:6px 12px; font-size:12px;">Cancel Upload</button>
        </div>
      </div>
    </div>

    <div class="form-group checkbox">
      <input 
        type="checkbox" 
        id="featured"
        name="featured" 
        {% if product and product.featured %}checked{% endif %}
      />
      <label for="featured">Featured Product (show on homepage)</label>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        {% if product %}Update Product{% else %}Create Product{% endif %}
      </button>
      <a class="btn btn-secondary" href="/admin">Cancel</a>
    </div>
  </form>
  
  <!-- Real-time product preview -->
  <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #ddd;">
    <h3 style="margin-bottom: 20px; color: #333;">Live Product Preview</h3>
    <div id="product-preview" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 800px;">
      <!-- Preview image -->
      <div style="text-align: center;">
        <div style="position: relative; background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 20px; min-height: 250px; display: flex; align-items: center; justify-content: center;">
          <img id="live-product-image" src="{{ product.image if product and product.image else '/static/placeholder.png' }}" alt="Product Preview" style="max-width: 100%; max-height: 250px; border-radius: 4px;">
        </div>
      </div>
      
      <!-- Preview details -->
      <div>
        <h4 id="live-product-title" style="margin: 0 0 10px 0; font-size: 18px; color: #333;">Product Title</h4>
        <p id="live-product-description" style="margin: 0 0 15px 0; color: #666; font-size: 14px; line-height: 1.5;">Product description will appear here</p>
        
        <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 4px;">
          <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px;">
            <span id="live-product-price" style="font-size: 24px; font-weight: bold; color: #007bff;">GH₵0.00</span>
            <span id="live-product-old-price" style="text-decoration: line-through; color: #999; font-size: 14px; display: none;">GH₵0.00</span>
            <span id="live-discount-badge" style="background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: none;">-0%</span>
          </div>
        </div>
        
        <button type="button" style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px;">Add to Cart</button>
        
        <div id="live-featured-badge" style="margin-top: 15px; display: none; padding: 10px; background: #ffd700; color: #333; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px;">⭐ Featured Product</div>
      </div>
    </div>
  </div>
</div>

<script>
// Image file preview
document.getElementById('image_file').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) {
    document.getElementById('preview-container').style.display = 'none';
    return;
  }
  
  // Validate file size (5MB)
  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) {
    alert('File size exceeds 5MB limit. Please choose a smaller image.');
    this.value = '';
    document.getElementById('preview-container').style.display = 'none';
    return;
  }
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(event) {
    document.getElementById('preview-image').src = event.target.result;
    document.getElementById('preview-container').style.display = 'block';
    
    // Update file info
    const sizeKB = (file.size / 1024).toFixed(2);
    document.getElementById('image-size').textContent = `File size: ${sizeKB} KB`;
    
    // Get image dimensions
    const img = new Image();
    img.onload = function() {
      document.getElementById('image-dimensions').textContent = `Dimensions: ${this.width} × ${this.height} px`;
    };
    img.src = event.target.result;
    
    // Update live preview
    document.getElementById('live-product-image').src = event.target.result;
  };
  reader.readAsDataURL(file);
});

// Cancel preview
document.getElementById('cancel-preview-btn').addEventListener('click', function() {
  document.getElementById('image_file').value = '';
  document.getElementById('preview-container').style.display = 'none';
  
  // Revert to current image if editing
  const currentImg = document.getElementById('current-img');
  if (currentImg) {
    document.getElementById('live-product-image').src = currentImg.src;
  } else {
    document.getElementById('live-product-image').src = '/static/placeholder.png';
  }
});

// Real-time product preview
function updateProductPreview() {
  const title = document.getElementById('title').value || 'Product Title';
  const description = document.getElementById('short').value || 'Product description will appear here';
  const price = parseFloat(document.getElementById('price').value) || 0;
  const oldPrice = parseFloat(document.getElementById('old_price').value) || 0;
  const featured = document.getElementById('featured').checked;
  
  // Update preview
  document.getElementById('live-product-title').textContent = title;
  document.getElementById('live-product-description').textContent = description;
  document.getElementById('live-product-price').textContent = `GH₵${price.toFixed(2)}`;
  
  // Show/hide old price and discount
  if (oldPrice > price && oldPrice > 0) {
    document.getElementById('live-product-old-price').style.display = 'inline';
    document.getElementById('live-product-old-price').textContent = `GH₵${oldPrice.toFixed(2)}`;
    
    const discountPercent = Math.round((1 - price / oldPrice) * 100);
    document.getElementById('live-discount-badge').textContent = `-${discountPercent}%`;
    document.getElementById('live-discount-badge').style.display = 'inline-block';
  } else {
    document.getElementById('live-product-old-price').style.display = 'none';
    document.getElementById('live-discount-badge').style.display = 'none';
  }
  
  // Show/hide featured badge
  document.getElementById('live-featured-badge').style.display = featured ? 'block' : 'none';
}

// Listen for changes on form fields
document.getElementById('title').addEventListener('input', updateProductPreview);
document.getElementById('short').addEventListener('input', updateProductPreview);
document.getElementById('price').addEventListener('input', updateProductPreview);
document.getElementById('old_price').addEventListener('input', updateProductPreview);
document.getElementById('featured').addEventListener('change', updateProductPreview);

// Initial preview update
updateProductPreview();
</script>

    <div class="form-group">
      <label for="card_size">Product Card Size</label>
      <select 
        id="card_size"
        name="card_size"
        class="form-control"
      >
        <option value="small" {% if product and product.card_size == 'small' %}selected{% endif %}>Small (Compact)</option>
        <option value="medium" {% if product and (not product or product.card_size == 'medium') %}selected{% endif %}>Medium (Standard)</option>
        <option value="large" {% if product and product.card_size == 'large' %}selected{% endif %}>Large (Featured)</option>
      </select>
      <small>Control how the product card displays on the shop. Large cards are good for featured items.</small>
    </div>

<style>
.admin-form-container {
  max-width: 900px;
  margin: 30px auto;
  padding: 20px;
  background: #f9f9f9;
  border-radius: 8px;
}

.admin-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: bold;
  color: #333;
}

.form-group input[type="text"],
.form-group input[type="number"],
.form-group input[type="file"],
.form-group textarea {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  font-family: inherit;
}

.form-group input[type="text"]:focus,
.form-group input[type="number"]:focus,
.form-group input[type="file"]:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
}

.form-group small {
  color: #666;
  font-size: 12px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }
  
  #product-preview {
    grid-template-columns: 1fr !important;
  }
}

.form-group.checkbox {
  flex-direction: row;
  align-items: center;
  gap: 10px;
}

.form-group.checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.form-group.checkbox label {
  margin: 0;
  cursor: pointer;
}

.current-image {
  margin-top: 10px;
  padding: 10px;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.current-image p {
  margin: 0 0 10px 0;
  font-size: 12px;
  color: #666;
}

.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.current-image-img {
  max-width: 150px;
  max-height: 150px;
  display: block;
  border-radius: 4px;
}

.admin-unlimited-note {
  margin-top:6px;
  color:#555;
  font-size:13px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  text-decoration: none;
  display: inline-block;
  transition: all 0.3s ease;
}

.btn-primary {
  background-color: #007bff;
  color: white;
}

.btn-primary:hover {
  background-color: #0056b3;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background-color: #545b62;
}

/* Product preview responsive improvements */
@media (max-width: 600px) {
  .admin-form-container {
    padding: 15px;
    margin: 15px auto;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    text-align: center;
  }
}
</style>
{% endblock %}